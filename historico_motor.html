<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IDMAR ‚Äî Hist√≥rico Motor</title>
  <link rel="icon" href="img/logo-pm.png" />

  <!-- Fallback CSS (tema CLARO) -->
  <style>
    :root{--bg:#f8fafc;--fg:#0f172a;--bg-elev:#ffffff;--border:#e5e7eb;--link:#0b6bcb}
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);margin:0;display:flex;flex-direction:column;
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    main{flex:1}
    .topbar{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-bottom:1px solid var(--border);background:var(--bg-elev)}
    .topbar img{height:36px}
    .topbar .brand{display:flex;flex-direction:column}
    .topbar .brand .app{font-weight:800}
    .topbar nav a{margin-right:1rem;color:var(--link);text-decoration:none}
    .container{max-width:1100px;margin:1.25rem auto;padding:0 1rem}
    .panel{background:var(--bg-elev);border:1px solid var(--border);border-radius:12px;padding:1rem;margin:.75rem 0}
    table{width:100%;border-collapse:collapse;margin-top:.5rem}
    th,td{border-bottom:1px solid var(--border);padding:.6rem .5rem;text-align:left;vertical-align:middle}
    .filters{display:grid;grid-template-columns:1.4fr 200px 160px 1fr 1fr;gap:.5rem}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
    .badge{display:inline-block;border-radius:999px;padding:.15rem .55rem;font-weight:600}
    .good{background:#10b98120;color:#065f46}
    .bad{background:#ef444420;color:#7f1d1d}
    .footer{border-top:1px solid var(--border);padding:1rem;text-align:left;opacity:.85;background:var(--bg-elev)}
    input,select,button{border:1px solid var(--border);background:#fff;border-radius:10px;padding:.5rem .6rem}
    button{cursor:pointer}
  </style>

  <!-- Gate de sess√£o simples -->
  <script>
    (function(){
      try{
        var ok = sessionStorage.getItem('IDMAR_SESSION')==='ok' || sessionStorage.getItem('NAV_SESSION')==='ok';
        if(!ok) location.replace('login.html');
      }catch(e){}
    })();
  </script>
</head>
<body>

  <!-- Topo de reserva (o layout.js injeta um uniforme por cima) -->
  <header class="topbar" id="fallback-topbar">
    <img src="img/logo-pm.png" alt="Pol√≠cia Mar√≠tima">
    <div class="brand">
      <span class="app">IDMAR</span>
      <small>Identifica√ß√£o Mar√≠tima ‚Äî Cascos &amp; Motores</small>
    </div>
    <nav style="margin-left:auto">
      <a href="validador.html">Validador</a>
      <a href="historico_win.html">Hist√≥rico WIN</a>
      <a href="historico_motor.html">Hist√≥rico Motor</a>
      <a href="forense.html">Forense</a>
      <a href="#" onclick="try{sessionStorage.clear()}catch(e){};location.href='login.html'">Sair</a>
    </nav>
  </header>

  <main class="container">
    <h1>Hist√≥rico ‚Äî Motores</h1>

    <section class="panel">
      <div class="filters">
        <input id="hist_motor_search" type="search" placeholder="Pesquisar (S/N / marca / modelo / texto)" />
        <select id="hist_motor_brand" aria-label="Marca">
          <option value="">Marca (todas)</option>
          <option>Yamaha</option><option>Honda</option><option>Suzuki</option><option>Tohatsu</option>
          <option>Mercury</option><option>MerCruiser</option><option>Volvo Penta</option>
          <option>Yanmar</option><option>Evinrude/Johnson</option>
        </select>
        <select id="hist_motor_state" aria-label="Estado">
          <option value="all">Estado (todos)</option>
          <option value="ok">V√°lido</option>
          <option value="bad">Inv√°lido</option>
        </select>
        <input id="hist_motor_from" type="date" placeholder="De" />
        <input id="hist_motor_to" type="date" placeholder="At√©" />
      </div>
      <div class="actions">
        <button id="hist_motor_csv">Exportar CSV</button>
        <button id="hist_motor_clear">Limpar hist√≥rico (Motor)</button>
      </div>
    </section>

    <section class="panel">
      <table>
        <thead>
          <tr>
            <th>Quando</th>
            <th>S/N</th>
            <th>Marca</th>
            <th>Modelo</th>
            <th>Estado</th>
            <th>Justifica√ß√£o</th>
            <th>Foto (nome)</th>
            <th>Miniatura</th>
          </tr>
        </thead>
        <tbody id="hist_motor_tbody"></tbody>
      </table>
    </section>
  </main>

  <footer class="footer" id="fallback-footer">IDMAR ‚Äî v2.2.7-baseline+merge-r2.3</footer>

  <!-- Topo/Rodap√© + tema claro -->
  <script src="js/idmar-layout.r3.js?v=r3"></script>

  <!-- (Opcional) L√≥gica externa do hist√≥rico Motor, se preferires separar -->
  <script src="js/historico-motor.js?v=r3a"></script>

  <!-- Fallback m√≠nimo (se o ficheiro acima n√£o carregar) -->
  <script>
    (function(){
      // se a tua vers√£o externa j√° tratar da p√°gina, este fallback n√£o interfere
      function ts(x){ if(x==null) return 0; if(typeof x==='number') return x; if(/^[0-9]+$/.test(String(x))) return Number(x); var t=Date.parse(x); return isNaN(t)?0:t; }
      function load(k){ try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch(e){ return []; } }
      function save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v||[])); }catch(e){} }

      function render(){
        var raw = load('hist_motor'); // chave fallback
        // Normalizamos poss√≠veis formatos existentes: {brand, sn, model, valid, reason, date, photoName, photoData}
        var q  = (document.getElementById('hist_motor_search')?.value||'').toLowerCase().trim();
        var br = (document.getElementById('hist_motor_brand')?.value||'').trim();
        var st = (document.getElementById('hist_motor_state')?.value||'all');
        var f  = document.getElementById('hist_motor_from')?.value||'';
        var t  = document.getElementById('hist_motor_to')?.value||'';

        var sorted = raw.slice().sort(function(a,b){
          return ts(b.date||b.dt||b.time||b.timestamp) - ts(a.date||a.dt||a.time||a.timestamp);
        });

        function inRange(r){
          var v = ts(r.date||r.dt||r.time||r.timestamp);
          var fts = f? ts(f+'T00:00:00'):null, tts = t? ts(t+'T23:59:59'):null;
          if(fts!=null && v<fts) return false;
          if(tts!=null && v>tts) return false;
          return true;
        }

        var data = sorted.filter(function(r){
          var blob = ((r.sn||'')+' '+(r.brand||'')+' '+(r.model||'')+' '+(r.reason||'')).toLowerCase();
          if(q && blob.indexOf(q)===-1) return false;
          if(br && (String(r.brand||'')!==br)) return false;
          if(st==='ok' && !r.valid) return false;
          if(st==='bad' && r.valid) return false;
          return inRange(r);
        });

        var tb = document.getElementById('hist_motor_tbody'); if(!tb) return;
        tb.innerHTML='';
        data.forEach(function(r){
          var tr = document.createElement('tr');
          var dtxt = new Date(ts(r.date||r.dt||r.time||r.timestamp)).toLocaleString();
          var stxt = r.valid ? '<span class="badge good">V√°lido</span>' : '<span class="badge bad">Inv√°lido</span>';
          var thumb = r.photoData ? '<img src="'+r.photoData+'" style="height:44px;border-radius:6px;border:1px solid var(--border)">' : '';
          var forensic = r.forense ? ' üîç' : '';
          tr.innerHTML = '<td>'+dtxt+'</td>'
            + '<td>'+(r.sn||r.serial||'')+'</td>'
            + '<td>'+(r.brand||'')+forensic+'</td>'
            + '<td>'+(r.model||'')+'</td>'
            + '<td>'+stxt+'</td>'
            + '<td>'+(r.reason||'')+'</td>'
            + '<td>'+(r.photoName||'')+'</td>'
            + '<td>'+thumb+'</td>';
          if(r.forense){ tr.title='Forense: '+JSON.stringify(r.forense); }
          tb.appendChild(tr);
        });
      }

      ['hist_motor_search','hist_motor_brand','hist_motor_state','hist_motor_from','hist_motor_to']
        .forEach(function(id){ var el=document.getElementById(id); if(el){ el.addEventListener('input',render); el.addEventListener('change',render); } });

      var csv = document.getElementById('hist_motor_csv');
      if(csv) csv.addEventListener('click', function(e){
        e.preventDefault();
        var all = load('hist_motor').slice().sort(function(a,b){
          return ts(b.date||b.dt||b.time||b.timestamp) - ts(a.date||a.dt||a.time||a.timestamp);
        });
        function esc(v){ return (v==null?'':String(v)).replace(/"/g,'""'); }
        var header=['date','brand','model','sn','valid','reason','photoName','forense.hash','forense.flags','forense.notes'];
        var lines=[header.join(',')];
        all.forEach(function(r){
          var row=[
            r.date||r.dt||r.time||r.timestamp||'',
            r.brand||'',
            r.model||'',
            r.sn||r.serial||'',
            r.valid?'1':'0',
            r.reason||'',
            r.photoName||'',
            (r.forense&&r.forense.hash)||'',
            (r.forense&&Array.isArray(r.forense.flags)?r.forense.flags.join('|'):''),
            (r.forense&&r.forense.notes)||''
          ].map(function(v){return '"'+esc(v)+'"';}).join(',');
          lines.push(row);
        });
        var blob=new Blob([lines.join('\\r\\n')],{type:'text/csv;charset=utf-8;'});
        var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='historico_motor.csv'; a.click(); URL.revokeObjectURL(url);
      });

      var clr = document.getElementById('hist_motor_clear');
      if(clr) clr.addEventListener('click', function(e){
        e.preventDefault();
        if(confirm('Limpar hist√≥rico Motor? Esta a√ß√£o √© irrevers√≠vel.')){
          save('hist_motor', []); render();
        }
      });

      document.addEventListener('DOMContentLoaded', render); render();
    })();
  </script>
</body>
</html>
