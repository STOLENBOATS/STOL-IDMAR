/* renderer */
document.addEventListener('DOMContentLoaded',function(){const T=document.body.dataset.hist||'win';const tbd=document.querySelector('#hist-tbl tbody');const q=document.getElementById('hist-q');const es=document.getElementById('hist-estado');const bm=document.getElementById('hist-marca');const f=document.getElementById('hist-from');const t=document.getElementById('hist-to');const clr=document.getElementById('hist-clear');const csv=document.getElementById('hist-csv');function render(L){if(!tbd)return;tbd.innerHTML='';L.sort(function(a,b){return (b.ts||0)-(a.ts||0)});L.forEach(function(r){var tr=document.createElement('tr');var main=(T==='win'?(r.win||''):(r.sn||''));var brand=r.brand||'';var model=r.model||'';var status=r.status||'';var when=r.when||'';tr.innerHTML='<td>'+when+'</td><td>'+main+'</td>'+(T==='motor'?('<td>'+brand+'</td><td>'+model+'</td>'):'')+'<td>'+status+'</td>';tbd.appendChild(tr);})}function apply(){const all=(window.IDMAR_HIST&&IDMAR_HIST.all(T))||[];var o={query:(q&&q.value||'').trim(),status:(es&&es.value?[es.value.toLowerCase()]:[])};if(f&&f.value){o.from=Date.parse(f.value)}if(t&&t.value){o.to=Date.parse(t.value+'T23:59:59')}if(T==='motor'&&bm&&bm.value){o.brand=bm.value}const F=(window.IDMAR_HIST&&IDMAR_HIST.filter(all,o))||[];render(F)}[q,es,bm,f,t].forEach(function(el){if(el){el.addEventListener('input',apply);if(el.tagName==='SELECT'){el.addEventListener('change',apply)}}});if(clr)clr.addEventListener('click',function(){if(confirm('Limpar histórico? Esta ação é irreversível.')){window.IDMAR_HIST&&IDMAR_HIST.clear(T);apply();}});if(csv)csv.addEventListener('click',function(){const all=(window.IDMAR_HIST&&IDMAR_HIST.all(T))||[];const F=(window.IDMAR_HIST&&IDMAR_HIST.filter(all,{query:(q&&q.value||'').trim()}))||[];window.IDMAR_HIST&&IDMAR_HIST.toCSV(T,F)});apply()});
