/* core */
(function(g){const K={win:'hist_win',motor:'hist_motor'};function n(){return Date.now()}function iso(t){try{return new Date(t).toISOString()}catch(e){return''}}function save(tp,rec){const k=K[tp];if(!k)return;try{const L=JSON.parse(localStorage.getItem(k)||'[]');const ts=rec.ts||n();const e=Object.assign({ts:ts,when:iso(ts)},rec);L.push(e);localStorage.setItem(k,JSON.stringify(L.slice(-1000)));return e}catch(e){console.error('hist save',e)}}function all(tp){const k=K[tp];if(!k)return[];try{return JSON.parse(localStorage.getItem(k)||'[]')}catch(e){return[]}}function clr(tp){const k=K[tp];if(!k)return;localStorage.removeItem(k)}function filt(L,o){o=o||{};return L.filter(function(r){if(o.query){var q=o.query.toLowerCase();var h=[r.win||'',r.nuipc||'',r.sn||'',r.brand||'',r.model||'',r.notes||''].join(' ').toLowerCase();if(h.indexOf(q)===-1)return false;}if(Array.isArray(o.status)&&o.status.length){if(o.status.indexOf((r.status||'').toLowerCase())===-1)return false;}if(o.brand&&r.brand&&r.brand!==o.brand)return false;if(o.from||o.to){var ts=r.ts||0;if(o.from&&ts<o.from)return false;if(o.to&&ts>o.to)return false;}return true})}function csv(tp,L){const C=['when','type','win','sn','brand','model','status','photo','notes'];const H=C.join(',');const R=L.map(r=>C.map(k=>JSON.stringify(r[k]||'')).join(','));const blob=[H].concat(R).join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([blob],{type:'text/csv;charset=utf-8;'}));a.download='idmar_'+tp+'_historico.csv';a.click();URL.revokeObjectURL(a.href)}g.IDMAR_HIST={save:save,all:all,clear:clr,filter:filt,toCSV:csv}})(window);
