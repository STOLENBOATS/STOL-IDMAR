<!doctype html>
<html lang="pt">

<head>

  <!-- DEMO GUARD: bypass auth + block redirects when ?demo=1 -->
  <script>
    (function(){
      const demo = /[?&]demo=1\b/.test(location.search);
      if (!localStorage.getItem('IDMAR_LANG')) localStorage.setItem('IDMAR_LANG','pt');
      if (!demo) return;
      window.IDMAR_DEMO = true;
      // Mock minimal auth session so auth checks pass
      window.IDMAR_AUTH = window.IDMAR_AUTH || {};
      window.IDMAR_AUTH.getSession = async () => ({ user:{ id: "demo-user" }, access_token: "demo" });
      // Block redirects while in demo
      const log = console.warn.bind(console, "[demo] blocked redirect:");
      const noop = (url)=> log(url);
      try {
        window.location.replace = noop;
        window.location.assign = noop;
      } catch(e){}
    })();
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IDMAR — Validador</title>
  <link rel="icon" href="img/logo-pm.png" />

  <!-- CSS base -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/theme-soft-light.v1.css"><!-- tema claro -->
  <link rel="stylesheet" href="css/nav-ribbon.v5.css"><!-- botões "ribbon" v5 -->

   <style>
    :root{--bg:#f8fafc;--fg:#0f172a;--bg-elev:#ffffff;--border:#e5e7eb;--link:#0b6bcb}
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);margin:0;display:flex;flex-direction:column;
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    main{flex:1}
    .container{max-width:1100px;margin:1.25rem auto;padding:0 1rem}
    .panel{background:var(--bg-elev);border:1px solid var(--border);border-radius:12px;padding:1rem;margin:.75rem 0}
    .two{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:980px){ .two{grid-template-columns:1fr 1fr} }
    label{display:block;margin:.35rem 0 .25rem}
    input[type="text"], input[type="search"], input[type="file"], select, textarea{
      width:100%;border:1px solid var(--border);background:#fff;border-radius:10px;padding:.5rem .6rem;
    }
    button{background:#0b6bcb;color:#fff;border:none;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:.5rem}
    th,td{border-bottom:1px solid var(--border);padding:.6rem .5rem;text-align:left}
    .small{opacity:.75;font-size:.9em}
    .badge{display:inline-block;border-radius:999px;padding:.15rem .55rem;font-weight:600}
    .good{background:#10b98120;color:#065f46}
    .bad{background:#ef444420;color:#7f1d1d}
    details.forense-box{margin-top:.75rem;border:1px dashed var(--border);border-radius:10px;padding:.5rem}
    .forense-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.5rem;margin-top:.5rem}
    .footer{border-top:1px solid var(--border);padding:1rem;text-align:left;opacity:.85;background:var(--bg-elev)}
  </style>
  
  <!-- Gate de sessão simples -->
  <script>
    (function(){
      try{
        var ok = sessionStorage.getItem('IDMAR_SESSION')==='ok' || sessionStorage.getItem('NAV_SESSION')==='ok';
        if(!ok) location.replace('login.html');
      }catch(e){}
    })();
  </script>

  <!-- Versão + branding -->
  <script>window.IDMAR_VERSION="Vs 1.3";</script>
  <script defer src="js/idmar-config.v4.js"></script>

  <!-- Core: i18n + header -->
  <script defer src="js/idmar-i18n.js"></script>
  <script defer src="js/idmar-header-only.all.v4.js"></script>

  <!-- Overrides (aplicam labels, ribbons e rodapé) -->
  <script defer src="js/header-override.v4.js"></script>
  <script defer src="js/i18n-boot.js"></script>
  <script defer src="js/idmar-version.v4.js"></script>
</head>

<body>
  <!-- header é injetado por JS -->

  <!-- HEADER ESTÁTICO (igual ao login) -->
<header class="app-header">
  <div class="brand">
    <img src="images/logo-pm.jpg" alt="Polícia Marítima" class="logo" />
    <div class="titles">
      <h1 data-en="IDMAR">IDMAR</h1>
      <p class="subtitle" data-en="Maritime Identification &amp; Engine Checker">
        Maritime Identification &amp; Engine Checker
      </p>
    </div>
  </div>

  <nav class="main-nav">
    <a href="validador.html" data-en="Validator">Validador</a>
    <a href="forense.html" data-en="Forensics">Forense</a>
    <a href="historico_win.html" data-en="WIN History">Histórico WIN</a>
    <a href="historico_motor.html" data-en="Engine History">Histórico Motor</a>

    <div class="lang-switch" style="margin-left: 12px; display:flex; align-items:center; gap:6px">
      <label for="langSel" data-en="Language">Idioma</label>
      <select id="langSel" aria-label="Language">
        <option value="pt" data-en="Portuguese">Português</option>
        <option value="en" data-en="English">English</option>
      </select>
    </div>
  </nav>
</header>


  <main class="container">
    <h1>Validador</h1>

    <section class="two">
      <!-- WIN -->
      <div class="panel">
        <h2>Validador WIN</h2>
        <form id="formWin">
          <label for="win">WIN / HIN</label>
          <input id="win" type="text" placeholder="Ex.: PT-ABC12345D404"/>
          <div style="margin:.5rem 0">
            <button id="btnWin" type="submit">Validar WIN</button>
          </div>

          <div style="margin-top:.5rem">
            <label for="winPhoto">Foto opcional / Optional photo</label>
            <input id="winPhoto" type="file" accept="image/*"/>
          </div>

          <div id="winOut" style="margin-top:.75rem"></div>

          <table>
            <thead>
              <tr><th>Campo / Field</th><th>Valor / Value</th><th>Interpretação / Meaning</th></tr>
            </thead>
            <tbody id="interpWinBody"></tbody>
          </table>
        </form>
      </div>

      <!-- MOTOR -->
      <div class="panel">
        <h2>Validador Motor</h2>
        <form id="formMotor">
          <label for="brand">Marca</label>
          <select id="brand">
            <option>Yamaha</option><option>Honda</option><option>Suzuki</option><option>Tohatsu</option>
            <option>Mercury</option><option>MerCruiser</option><option>Volvo Penta</option>
            <option>Yanmar</option><option>Evinrude/Johnson</option>
          </select>

          <div id="brandDynamic"></div>

          <div style="margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.5rem">
            <div><label>Modelo (pesquisa)</label><input id="srch_model" type="text" placeholder="Ex.: DF140A"/></div>
            <div><label>Potência (hp)</label><input id="srch_power" type="text" placeholder="Ex.: 150"/></div>
            <div><label>Cilindrada (cc)</label><input id="srch_disp" type="text" placeholder="Ex.: 2670"/></div>
            <div><label>Ano</label><input id="srch_year" type="text" placeholder="Ex.: 2017"/></div>
            <div><label>Origem</label><input id="srch_origin" type="text" placeholder="Ex.: Japão"/></div>
          </div>

          <div style="margin:.5rem 0">
            <button id="btnMotor" type="submit">Validar Motor</button>
          </div>

          <div style="margin-top:.5rem">
            <label for="motorPhoto">Foto opcional / Optional photo</label>
            <input id="motorPhoto" type="file" accept="image/*"/>
          </div>

          <div id="motorOut" style="margin-top:.75rem"></div>
        </form>
      </div>
    </section>
  </main>

  <footer class="footer" id="fallback-footer">IDMAR — Identificação Marítima</footer>

  <!-- Removido idmar-layout.r3b.js para não duplicar header -->
  <script src="js/validador-win.r3b.js?v=r3b"></script>
  <script src="js/validador-motor.r3b.js?v=r3b"></script>

  <script>
/* IDMAR page i18n runtime — PT por defeito, EN quando escolhido.
   Suporta 3 fontes de texto:
   1) data-en / data-en-placeholder / data-enattr-title|aria-label
   2) texto "PT / EN" (divide e usa a parte certa)
   3) caso só exista PT, mantém PT (não inventa EN)
*/
(function(){
  const LS_KEY = "IDMAR_LANG";
  const NODES = "h1,h2,h3,h4,h5,h6,label,th,td,button,summary,legend,span,strong,b,p,li,dt,dd";
  const ATTRS = ["title","aria-label"];

  const getLang = () => (localStorage.getItem(LS_KEY) || (document.documentElement.getAttribute("lang")||"pt")).toLowerCase();
  const norm   = s => (s||"").replace(/\s+/g," ").trim();
  const splitB = s => {
    if (!s) return null;
    const i = s.indexOf(" / ");
    return i >= 0 ? [s.slice(0,i).trim(), s.slice(i+3).trim()] : null;
  };

  function setText(el, pt, en, lang){
    if (lang === "en" && en){ el.textContent = en; return; }
    if (pt){ el.textContent = pt; return; }
  }
  function setAttr(el, a, pt, en, lang){
    if (lang === "en" && en){ el.setAttribute(a, en); return; }
    if (pt){ el.setAttribute(a, pt); return; }
  }
  function setPlaceholder(el, pt, en, lang){
    if (lang === "en" && en){
      // pequenos ajustes comuns
      en = en.replace(/^\s*Ex\.\s*:/i,"E.g.:");
      setTimeout(()=> el.setAttribute("placeholder", en),0);
    } else if (pt){
      setTimeout(()=> el.setAttribute("placeholder", pt),0);
    }
  }

  function apply(root=document){
    const lang = getLang();
    // Texto principal
    root.querySelectorAll(NODES).forEach(el=>{
      // 1) data-*
      const ptData = el.getAttribute("data-pt");
      const enData = el.getAttribute("data-en");
      if (ptData || enData){ setText(el, ptData ?? el.textContent, enData, lang); return; }

      // 2) "PT / EN"
      const raw = norm(el.textContent);
      const pair = splitB(raw);
      if (pair){
        const [pt,en] = pair;
        // guarda PT como data-pt para voltar sem perder
        el.setAttribute("data-pt", pt);
        el.setAttribute("data-en", en);
        setText(el, pt, en, lang);
      }
    });

    // Placeholders
    root.querySelectorAll("input[placeholder],textarea[placeholder]").forEach(el=>{
      const ptAttr = el.getAttribute("data-pt-placeholder");
      const enAttr = el.getAttribute("data-en-placeholder");
      if (ptAttr || enAttr){ setPlaceholder(el, ptAttr ?? el.getAttribute("placeholder"), enAttr, lang); return; }
      const ph = el.getAttribute("placeholder");
      const pair = splitB(ph);
      if (pair){
        el.setAttribute("data-pt-placeholder", pair[0]);
        el.setAttribute("data-en-placeholder", pair[1]);
        setPlaceholder(el, pair[0], pair[1], lang);
      }
    });

    // Atributos comuns
    root.querySelectorAll("*").forEach(el=>{
      ATTRS.forEach(a=>{
        const ptA = el.getAttribute("data-ptattr-"+a);
        const enA = el.getAttribute("data-enattr-"+a);
        if (ptA || enA){ setAttr(el, a, ptA, enA, lang); return; }
        const v = el.getAttribute(a);
        const pair = splitB(v);
        if (pair){
          el.setAttribute("data-ptattr-"+a, pair[0]);
          el.setAttribute("data-enattr-"+a, pair[1]);
          setAttr(el, a, pair[0], pair[1], lang);
        }
      });
    });

    // <option>
    root.querySelectorAll("option").forEach(opt=>{
      const pt = opt.getAttribute("data-pt") ?? opt.textContent;
      const en = opt.getAttribute("data-en");
      if (!en){
        const pair = splitB(opt.textContent);
        if (pair){ opt.setAttribute("data-pt", pair[0]); opt.setAttribute("data-en", pair[1]); setText(opt, pair[0], pair[1], lang); }
        else opt.setAttribute("data-pt", pt);
      } else {
        setText(opt, pt, en, lang);
      }
    });

    document.documentElement.setAttribute("lang", lang);
  }

  // Primeiro arranque
  function boot(){ apply(); }
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot); else boot();

  // Reaplicar quando:
  document.addEventListener("change", e=>{ if (e.target && e.target.id === "langSel") apply(); });
  document.addEventListener("idmar:ui-updated", apply);
  window.addEventListener("storage", e=>{ if (e.key === "IDMAR_LANG") apply(); });

  // Segurança para UIs injetadas tardiamente
  const mo = new MutationObserver(m=>{ for (const x of m){ if (x.addedNodes && x.addedNodes.length){ apply(); break; } } });
  try { mo.observe(document.body, {childList:true, subtree:true}); } catch(e){}
})();
</script>
  
</body>
</html>
