<!doctype html>
<html lang="pt">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IDMAR — Validador</title>
  <link rel="icon" href="img/logo-pm.png" />

  <!-- CSS base -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/theme-soft-light.v1.css"><!-- tema claro -->
  <link rel="stylesheet" href="css/nav-ribbon.v5.css"><!-- botões "ribbon" v5 -->

   <style>
    :root{--bg:#f8fafc;--fg:#0f172a;--bg-elev:#ffffff;--border:#e5e7eb;--link:#0b6bcb}
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);margin:0;display:flex;flex-direction:column;
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    main{flex:1}
    .container{max-width:1100px;margin:1.25rem auto;padding:0 1rem}
    .panel{background:var(--bg-elev);border:1px solid var(--border);border-radius:12px;padding:1rem;margin:.75rem 0}
    .two{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:980px){ .two{grid-template-columns:1fr 1fr} }
    label{display:block;margin:.35rem 0 .25rem}
    input[type="text"], input[type="search"], input[type="file"], select, textarea{
      width:100%;border:1px solid var(--border);background:#fff;border-radius:10px;padding:.5rem .6rem;
    }
    button{background:#0b6bcb;color:#fff;border:none;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:.5rem}
    th,td{border-bottom:1px solid var(--border);padding:.6rem .5rem;text-align:left}
    .small{opacity:.75;font-size:.9em}
    .badge{display:inline-block;border-radius:999px;padding:.15rem .55rem;font-weight:600}
    .good{background:#10b98120;color:#065f46}
    .bad{background:#ef444420;color:#7f1d1d}
    details.forense-box{margin-top:.75rem;border:1px dashed var(--border);border-radius:10px;padding:.5rem}
    .forense-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.5rem;margin-top:.5rem}
    .footer{border-top:1px solid var(--border);padding:1rem;text-align:left;opacity:.85;background:var(--bg-elev)}
  </style>
  
  <!-- Gate de sessão simples -->
  <script>
    (function(){
      try{
        var ok = sessionStorage.getItem('IDMAR_SESSION')==='ok' || sessionStorage.getItem('NAV_SESSION')==='ok';
        if(!ok) location.replace('login.html');
      }catch(e){}
    })();
  </script>

  <!-- Versão + branding -->
  <script>window.IDMAR_VERSION="Vs 1.3";</script>
  <script defer src="js/idmar-config.v4.js"></script>

  <!-- Core: i18n + header -->
  <script defer src="js/idmar-i18n.js"></script>
  <script defer src="js/idmar-header-only.all.v4.js"></script>

  <!-- Overrides (aplicam labels, ribbons e rodapé) -->
  <script defer src="js/header-override.v4.js"></script>
  <script defer src="js/i18n-boot.js"></script>
 
</head>

<body>
  <!-- header é injetado por JS -->

  <main class="container">
    <h1>Validador</h1>

    <section class="two">
      <!-- WIN -->
      <div class="panel">
        <h2>Validador WIN</h2>
        <form id="formWin">
          <label for="win">WIN / HIN</label>
          <input id="win" type="text" placeholder="Ex.: PT-ABC12345D404"/>
          <div style="margin:.5rem 0">
            <button id="btnWin" type="submit">Validar WIN</button>
          </div>

          <div style="margin-top:.5rem">
            <label for="winPhoto">Foto opcional / Optional photo</label>
            <input id="winPhoto" type="file" accept="image/*"/>
          </div>

          <div id="winOut" style="margin-top:.75rem"></div>

          <table>
            <thead>
              <tr><th>Campo / Field</th><th>Valor / Value</th><th>Interpretação / Meaning</th></tr>
            </thead>
            <tbody id="interpWinBody"></tbody>
          </table>
        </form>
      </div>

      <!-- MOTOR -->
      <div class="panel">
        <h2>Validador Motor</h2>
        <form id="formMotor">
          <label for="brand">Marca</label>
          <select id="brand">
            <option>Yamaha</option><option>Honda</option><option>Suzuki</option><option>Tohatsu</option>
            <option>Mercury</option><option>MerCruiser</option><option>Volvo Penta</option>
            <option>Yanmar</option><option>Evinrude/Johnson</option>
          </select>

          <div id="brandDynamic"></div>

          <div style="margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.5rem">
            <div><label>Modelo (pesquisa)</label><input id="srch_model" type="text" placeholder="Ex.: DF140A"/></div>
            <div><label>Potência (hp)</label><input id="srch_power" type="text" placeholder="Ex.: 150"/></div>
            <div><label>Cilindrada (cc)</label><input id="srch_disp" type="text" placeholder="Ex.: 2670"/></div>
            <div><label>Ano</label><input id="srch_year" type="text" placeholder="Ex.: 2017"/></div>
            <div><label>Origem</label><input id="srch_origin" type="text" placeholder="Ex.: Japão"/></div>
          </div>

          <div style="margin:.5rem 0">
            <button id="btnMotor" type="submit">Validar Motor</button>
          </div>

          <div style="margin-top:.5rem">
            <label for="motorPhoto">Foto opcional / Optional photo</label>
            <input id="motorPhoto" type="file" accept="image/*"/>
          </div>

          <div id="motorOut" style="margin-top:.75rem"></div>
        </form>
      </div>
    </section>
  </main>

  <footer class="footer" id="fallback-footer">IDMAR — Identificação Marítima</footer>

  <!-- Removido idmar-layout.r3b.js para não duplicar header -->
  <script src="js/validador-win.r3b.js?v=r3b"></script>
  <script src="js/validador-motor.r3b.js?v=r3b"></script>
  <script src="js/idmar-win-cert.v1.js?v=1.2"></script>
  
<script>
/*! IDMAR – Certificado de Conformidade (drop-in inline) v1.2 */
(function(w,d){
  const LS_KEY="IDMAR_LANG";
  const t=(pt,en)=>((localStorage.getItem(LS_KEY)||d.documentElement.getAttribute("lang")||"pt").toLowerCase()==="en"?en:pt);
  const qs=(s,r)=> (r||d).querySelector(s);

  function sanitize(x){ return String(x||"").replace(/[^A-Za-z0-9]/g,"").toUpperCase().trim(); }
  function fix2(n){ return (n>=70?1900+n:2000+n); }
  function parseModelYear(code){
    const c=sanitize(code); if(!c) return null;
    if(c.length===14 && /^\w{14}$/.test(c)){ const yy=c.slice(-2); if(/^\d{2}$/.test(yy)) return fix2(+yy); }
    if(c.length===12 && /^\w{12}$/.test(c)){ const yy=c.slice(-2); if(/^\d{2}$/.test(yy)) return fix2(+yy); }
    const m=c.match(/(\d{2})$/); if(m) return fix2(+m[1]);
    return null;
  }

  function rule(year,flags){
    if(year==null) return {level:"info",code:"CE_UNKNOWN",
      title:t("Certificado de Conformidade","Certificate of Conformity"),
      detail:t("Sem ano de modelo — não é possível determinar obrigação CE.","No model year — cannot determine CE obligation.")};
    if(year<1998) return {level:"ok",code:"CE_NOT_REQUIRED",
      title:t("Certificado de Conformidade","Certificate of Conformity"),
      detail:t("Dispensado (anterior a 1998 — fora do âmbito RCD).","Not required (before 1998 — outside RCD scope).")};
    if(flags.pca) return {level:"warn",code:"CE_PCA_REQUIRED",
      title:t("Certificado de Conformidade (PCA)","Certificate of Conformity (PCA)"),
      detail:t("Requer Avaliação Pós-Construção (PCA) com Declaração UE de Conformidade.","Requires Post Construction Assessment (PCA) with EU Declaration of Conformity.")};
    if(year>=2016) return {level:"need",code:"CE_EU_DOC_REQUIRED",
      title:t("Declaração UE de Conformidade","EU Declaration of Conformity"),
      detail:t("Obrigatória ao abrigo da Diretiva 2013/53/EU (RCD II).","Mandatory under Directive 2013/53/EU (RCD II).")};
    return {level:"need",code:"CE_DOC_REQUIRED",
      title:t("Declaração de Conformidade CE","CE Declaration of Conformity"),
      detail:t("Obrigatória ao abrigo da Diretiva 94/25/CE (RCD I).","Mandatory under Directive 94/25/EC (RCD I).")};
  }

  function badge(r){
    const colors={ok:"#065f46",need:"#7c2d12",warn:"#92400e",info:"#1f2937"};
    const bgs={ok:"#10b98120",need:"#ef444420",warn:"#f59e0b20",info:"#6b728020"};
    return `<span style="display:inline-block;padding:.15rem .55rem;border-radius:999px;background:${bgs[r.level]};color:${colors[r.level]};font-weight:600">${r.title}</span>`;
  }

  function ensurePanel(){
    let host=qs("#winCertPanel");
    if(host) return host;
    host=d.createElement("section");
    host.id="winCertPanel";
    host.style.cssText="margin-top:.75rem;border:1px solid var(--border,#e5e7eb);border-radius:12px;padding:.8rem 1rem;background:var(--bg-elev,#fff)";
    // inserir no painel WIN, perto do resultado
    const anchor = qs("#winOut") || qs("#winResult") || qs("#interpWinBody")?.parentElement || qs("#formWin") || qs("main") || d.body;
    anchor.appendChild(host);

    // flags + checkbox “apresentado”
    const controls=d.createElement("div");
    controls.style.cssText="display:flex;gap:10px;flex-wrap:wrap;margin:0 0 .5rem 0";
    controls.innerHTML = `
      <label style="display:flex;gap:.35rem;align-items:center"><input type="checkbox" id="flagHome"> <span>${t("Construção amadora","Home-built")}</span></label>
      <label style="display:flex;gap:.35rem;align-items:center"><input type="checkbox" id="flagImported"> <span>${t("Importado usado (extra-UE)","Imported used (non-EU)")}</span></label>
      <label style="display:flex;gap:.35rem;align-items:center;margin-left:auto"><input type="checkbox" id="certPresented"> <span>${t("Certificado apresentado","Certificate presented")}</span></label>
    `;
    host.appendChild(controls);

    const body=d.createElement("div"); body.id="winCertBody"; host.appendChild(body);

    controls.addEventListener("change",()=>render());
    return host;
  }

  function currentWIN(){
    const el=qs("#win")||qs("#hin")||qs('input[name="win"]'); return el?el.value:"";
  }

  function render(){
    const host=ensurePanel(); const body=qs("#winCertBody",host);
    const year=parseModelYear(currentWIN());
    const flags={pca:(qs("#flagHome",host)?.checked||qs("#flagImported",host)?.checked)};
    const r=rule(year,flags);
    body.innerHTML = `
      <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin:.25rem 0 .35rem 0">
        ${badge(r)}
        <small style="opacity:.8">${t("Modelo","Model year")}: ${year??"—"}</small>
      </div>
      <div style="font-size:.95em;opacity:.9;margin-top:.2rem">${r.detail}</div>
    `;
  }

  function boot(){
    const input=qs("#win")||qs("#hin")||qs('input[name="win"]');
    if(input && !input.__win_cert_hook){
      input.__win_cert_hook=true;
      input.addEventListener("input",render);
    }
    render();
    try{
      const targets=[qs("#winOut"),qs("#winResult"),qs("#interpWinBody")?.parentElement].filter(Boolean);
      const mo=new MutationObserver(render); targets.forEach(t=>mo.observe(t,{childList:true,subtree:true}));
    }catch(e){}
    d.addEventListener("idmar:ui-updated",render);
    w.addEventListener("storage",e=>{ if(e.key===LS_KEY) render(); });
  }
  if(d.readyState==="loading") d.addEventListener("DOMContentLoaded",boot); else boot();
})(window,document);
</script>
  
</body>
</html>
